<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<title>Assigned Orders</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
body{
    background:#f4f6f9;
}

/* ================= Sidebar ================= */
#sidebar{
    width:240px;
    min-height:100vh;
    background:#0b1e33;
    transition:0.3s;
}

#sidebar.collapsed{
    width:75px;
}

#sidebar .nav-link{
    color:#cfd8dc;
    padding:14px 20px;
    display:flex;
    align-items:center;
    gap:12px;
    border-radius:8px;
    white-space:nowrap;
}

#sidebar .nav-link:hover,
#sidebar .active{
    background:#163a5f;
    color:white;
}

#sidebar.collapsed .nav-link span{
    display:none;
}

#sidebar.collapsed .brand-text{
    display:none;
}

/* ================= Topbar ================= */
.topbar{
    height:70px;
    background:white;
    box-shadow:0 2px 6px rgba(0,0,0,0.05);
}

/* ================= Card ================= */
.card{
    border:none;
    border-radius:15px;
}

/* ================= Action Column ================= */
.action-wrapper{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
}

.code-input{
    width:110px;
}

.table td{
    vertical-align:middle;
}

/* ================= Profile Dropdown ================= */
.profile-dropdown{
    position:relative;
    cursor:pointer;
    margin-left:auto;
}

.profile-dropdown-menu{
    position:absolute;
    right:0;
    top:120%;
    background:white;
    border-radius:14px;
    box-shadow:0 10px 30px rgba(0,0,0,0.18);
    display:none;
    min-width:170px;
    overflow:hidden;
    z-index:100;
}

.profile-dropdown-menu a{
    display:block;
    padding:12px 16px;
    color:#0b1e33;
    text-decoration:none;
    font-size:0.95rem;
}

.profile-dropdown-menu a:hover{
    background:#f1f5f9;
}
</style>
</head>

<body>

<div class="d-flex">

    <!-- ================= Sidebar ================= -->
    <div id="sidebar" class="p-3">

        <div class="text-center text-white mb-4 fw-bold fs-5 brand-text">
            FuelIndeed
        </div>

        <ul class="nav flex-column">
        
            <li>
                <a href="#" class="nav-link" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                    <span class="nav-text">Menu</span>
                </a>
            </li>

            <li>
                <a th:href="@{/delivery/dashboard}" class="nav-link">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
            </li>

            <li>
                <a th:href="@{/delivery/assigned}" class="nav-link active">
                    <i class="fas fa-list"></i>
                    <span>Assigned Orders</span>
                </a>
            </li>

            <li>
                <a th:href="@{/delivery/delivered}" class="nav-link">
                    <i class="fas fa-truck"></i>
                    <span>Delivered</span>
                </a>
            </li>

            <li>
                <a th:href="@{/delivery/not-delivered}" class="nav-link">
                    <i class="fas fa-times-circle"></i>
                    <span>Not Delivered</span>
                </a>
            </li>

        </ul>
    </div>

    <!-- ================= Main Content ================= -->
    <div class="flex-grow-1">

        <!-- ================= Topbar ================= -->
        <div class="topbar d-flex align-items-center px-4">

            <div class="d-flex align-items-center gap-2">
                <i class="fas fa-truck-fast text-primary fs-5"></i>
                <span class="fw-semibold text-dark">Delivery Agent Dashboard</span>
            </div>

            <div class="profile-dropdown" onclick="toggleProfileMenu()">
                <i class="fas fa-user-circle fs-3 text-secondary"></i>
                <div class="profile-dropdown-menu" id="profileMenu">
                    <a th:href="@{/delivery/profile}">
                        <i class="fas fa-user me-2"></i>My Profile
                    </a>
                    <a th:href="@{/delivery/logout}">
                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                    </a>
                </div>
            </div>

        </div>

        <!-- ================= Table Section ================= -->
        <div class="container-fluid p-4">
            <div class="card shadow-sm p-4">

                <div class="table-responsive">
                    <table class="table align-middle text-center">

                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>User</th>
                                <th>Fuel</th>
                                <th>Quantity</th>
                                <th>Total</th>
                                <th>Delivery Address</th>
                                <th>Location</th>
                                <th>Action</th>
                            </tr>
                        </thead>

                        <tbody>
                            <tr th:each="b : ${bookings}">

                                <td th:text="${b.id}"></td>
                                <td th:text="${b.user.name}"></td>
                                <td th:text="${b.fuelType}"></td>
                                <td th:text="${b.quantity}"></td>
                                <td>‚Çπ <span th:text="${b.totalBill}"></span></td>

                                <!-- üìç ADDRESS -->
                                <td th:text="${b.deliveryAddress}"></td>

                                <!-- üó∫ MAP -->
                                <td>
                                    <a th:if="${b.latitude != null}"
                                       th:href="'https://www.google.com/maps?q=' 
                                       + ${b.latitude} + ',' + ${b.longitude}"
                                       target="_blank"
                                       class="btn btn-sm btn-outline-primary">
                                       üìç Map
                                    </a>

                                    <span th:if="${b.latitude == null}" class="text-muted">
                                        No GPS
                                    </span>
                                </td>

                                <!-- ACTION -->
                                <td>
                                    <div class="action-wrapper">

                                        <!-- Delivered -->
                                        <form th:action="@{/delivery/mark-delivered}" 
                                              method="post"
                                              class="d-flex align-items-center gap-2 m-0">

                                            <input type="hidden" 
                                                   name="bookingId" 
                                                   th:value="${b.id}">

                                            <input type="text" 
                                                   name="code"
                                                   placeholder="Code"
                                                   class="form-control form-control-sm code-input"
                                                   required>

                                            <button type="submit" 
                                                    class="btn btn-success btn-sm px-3">
                                                Delivered
                                            </button>
                                        </form>

                                        <!-- Not Delivered -->
                                        <form th:action="@{/delivery/mark-not-delivered}" 
                                              method="post"
                                              class="m-0">

                                            <input type="hidden" 
                                                   name="bookingId" 
                                                   th:value="${b.id}">

                                            <button type="submit" 
                                                    class="btn btn-danger btn-sm px-3">
                                                Not Delivered
                                            </button>
                                        </form>

                                    </div>
                                </td>

                            </tr>

                            <tr th:if="${#lists.isEmpty(bookings)}">
                                <td colspan="8" class="text-muted text-center">
                                    No assigned orders
                                </td>
                            </tr>

                        </tbody>

                    </table>
                </div>

            </div>
        </div>

    </div>
</div>

<!-- ================= Scripts ================= -->
<script>
function toggleSidebar(){
    document.getElementById("sidebar").classList.toggle("collapsed");
}

function toggleProfileMenu(){
    let menu=document.getElementById("profileMenu");
    menu.style.display = menu.style.display==="block" ? "none" : "block";
}

window.onclick=function(e){
    if(!e.target.closest(".profile-dropdown")){
        document.getElementById("profileMenu").style.display="none";
    }
}
</script>

</body>
</html>